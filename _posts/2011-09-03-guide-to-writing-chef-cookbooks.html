---
layout: post
title: Guide to Writing Chef Cookbooks
published: true
categories: [oldstuff, chef]
---
<p>I wanted smartmontools installed to monitor the disk health of my LAN server at home. This is not an uncommon thing to want to do, so I thought I'd write and share a Chef cookbook for it. I also took this opportunity to write up the experience so I can illustrate how easy it is to write a cookbook for Chef.</p>
<p>The first thing to do when writing a cookbook is to create the cookbook directory structure with <code>knife cookbook create</code>. This command will create a README.rdoc by default, and I prefer Markdown, so I specify the <code>-r md</code> option.</p>
<div class="CodeRay">
  <div class="code"><pre>knife cookbook create smartmontools -r md</pre></div>
</div>

<p>By default, metadata and the default recipe are created with boilerplate content for author and copyright. I have configured the values in my knife.rb:</p>
<div class="CodeRay">
  <div class="code"><pre>cookbook_copyright &quot;Joshua Timberman&quot;
cookbook_license   &quot;apachev2&quot;
cookbook_email     &quot;cookbooks@housepub.org&quot;</pre></div>
</div>

<p>The resulting directory structure will be created:</p>
<div class="CodeRay">
  <div class="code"><pre>% tree cookbooks/smartmontools
cookbooks/smartmontools
├── README.md
├── attributes
├── definitions
├── files
│   └── default
├── libraries
├── metadata.rb
├── providers
├── recipes
│   └── default.rb
├── resources
└── templates
    └── default

10 directories, 3 files</pre></div>
</div>

<h2>README Driven Development</h2>
<p>I'm a big fan of Tom Preston-Werner's blog post on <a href="http://tom.preston-werner.com/2010/08/23/readme-driven-development.html" name="README Driven Development">README driven development</a>. I don't write the complete README before I start writing code for a new cookbook. I do write it as I go.</p>
<p>In order to write a proper README for a cookbook, and to write the cookbook itself, we'll need to know a bit more about the software we're installing. The best way to do that depends on the software, but often it is as simple as merely installing the package on a test system such as a virtual machine and explore its contents.</p>
<div class="CodeRay">
  <div class="code"><pre>apt-get install smartmontools
dpkg -L smartmontools</pre></div>
</div>

<p>Of note for smartmontools, documentation is in <code>/usr/share/doc/smartmontools</code> and configuration is in <code>/etc</code>. In particular, <code>/etc/smartd.conf</code> and <code>/etc/smartmontools</code>.</p>
<p>For now assume that the cookbook README.md is being written along the way.</p>
<h3>List of Resources</h3>
<p>One of the things I do when I am writing a new cookbook and exploring the contents of a package is to be mindful of <a href="http://wiki.opscode.com/display/chef/Resources" name="Chef Resources">Chef Resources</a> I want to manage in the recipe(s). In the case of smartmontools, at this point I have determined I need a few specific resources.</p>
<h3>Install the Package</h3>
<p>First, as I've installed the package, I clearly need a package. I'm pretty confident that this particular package will not break backwards compatibility, and can be safely upgraded to the latest version if necessary.</p>
<p><script src="https://gist.github.com/1192321.js"></script></p>
<h3>Configuration files are templates</h3>
<p>The next resources in the recipe are the configuration files. I want to dynamically configure these, so I am going to use <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Template" name="templates">templates</a>.</p>
<p><script src="https://gist.github.com/1192326.js"></script></p>
<p>I'm not going to write these from scratch. Instead, I will copy the source files from the installed package on my test system. These will go into <code>templates/default</code> in the cookbook.</p>
<div class="CodeRay">
  <div class="code"><pre>% tree templates
templates
└── default
    ├── smartd.conf.erb
    └── smartmontools.default.erb</pre></div>
</div>

<p>Templates are dynamically generated using ERB, and they can use Node attributes. I can use the automatically detected attributes, or I can set new attributes for the node in the cookbook.</p>
<h3>Attributes Used in the Templates</h3>
<p>The attributes go in the <code>attributes/default.rb</code> file in the cookbook. The ones I use are:</p>
<p><script src="https://gist.github.com/1192329.js"></script></p>
<p>Attributes are definitely something to document in the README.</p>
<p>In <code>templates/default/smartd.conf.erb</code>, I check if there's a list of devices to monitor, and if so iterate over the list passing in the default options (<code>device_opts</code>). The cookbook doesn't at this time support per-device options - the same ones are applied to all devices. If <code>devices</code> is empty, then the configuration will use DEVICESCAN.</p>
<div class="CodeRay">
  <div class="code"><pre>&lt;% if node['smartmontools']['devices'].length &gt; 0 -%&gt;
&lt;%   node['smartmontools']['devices'].each do |device| -%&gt;
&lt;%=    &quot;/dev/#{device} #{node['smartmontools']['device_opts']}&quot; %&gt;
&lt;%   end -%&gt;
&lt;% else -%&gt;

DEVICESCAN -m root -M exec /usr/share/smartmontools/smartd-runner
&lt;% end -%&gt;</pre></div>
</div>

<p>In <code>templates/default/smartmontools.default.erb</code>, the smartmontools daemon will be enabled based on the <code>start_smartd</code> attribute. Additional options will be passed per <code>smartd_opts</code>:</p>
<div class="CodeRay">
  <div class="code"><pre>start_smartd=&lt;%= node['smartmontools']['start_smartd'] %&gt;

&lt;% if node['smartmontools']['smartd_opts'].length &gt; 0 -%&gt;
smartd_opts=&quot;&lt;%= node['smartmontools']['smartd_opts'] %&gt;&quot;
&lt;% else -%&gt;
#smartd_opts=&quot;--interval=1800&quot;
&lt;% end -%&gt;</pre></div>
</div>

<p>Generally speaking when creating attributes and using them in a template, I use the default values that are found in the configuration file dropped off by the package. I also try to use the default settings over all.</p>
<p>However, a cookbook is a place to express opinions. I made some with this cookbook, such as enabling DEVICESCAN if there are no devices, despite the configuration file's comments indicating that the option shouldn't be used. The best thing about attributes is they allow other people using the cookbook to change the behavior based on their preferences much easier than manually modifying things dropped off by a package.</p>
<p>I strongly recommend documenting where a cookbook has behavior that is not default for the installed package or upstream documentation. I did this in the README for this cookbook discussing the DEVICESCAN option and otherwise where appropriate.</p>
<h3>Static Files</h3>
<p>This cookbook has only one static file which will be deployed to <code>/etc/smartmontools/run.d/10mail</code>. The smartmontools package allows creating a number of scripts that go in the directory, and I have created an attribute for the list of scripts. These generally don't <code>cookbook_file</code> resources. Since the list is an attribute, I iterate over that with Ruby's Array#each loop.</p>
<p>The attribute:</p>
<p><script src="https://gist.github.com/1192332.js"></script></p>
<p>The loop of resources:</p>
<p><script src="https://gist.github.com/1192334.js"></script></p>
<p>Each filename in the array (currently only '10mail') needs to have a corresponding file in the <code>files/default</code> directory of the cookbook.</p>
<div class="CodeRay">
  <div class="code"><pre>% tree files
files
└── default
    └── 10mail</pre></div>
</div>

<p>This file's contents are not particularly exciting, I used the same one that came out of the package.</p>
<p>Why would I want to manage a static file that came from the package? Perhaps I want to modify the script in some way that doesn't make sense in an attribute. In this case I don't, however creating the attribute and iterating over it makes it easy to extend this functonality in the cookbook.</p>
<h3>Manage the Service</h3>
<p>Smartmontools comes with a service. That is, there's an init script that can be enabled and started to monitor disk devices. This is actually the whole point of the cookbook, so I'll make sure there's a resource to manage the service.</p>
<p><script src="https://gist.github.com/1192336.js"></script></p>
<p>In this resource, I used the meta parameter <code>supports</code> for the service. I found out what the init script can do by simply running it with no options on my test system.</p>
<div class="CodeRay">
  <div class="code"><pre>% /etc/init.d/smartmontools
Usage: /etc/init.d/smartmontools {start|stop|restart|reload|force-reload|status}</pre></div>
</div>

<p>The various options passed to the init script manage it in the familiar way. Telling Chef about it has a specific effect on the way the service provider functions when Chef manages it.</p>
<ul>
<li> status: Chef will use <code>/etc/init.d/SERVICE_NAME status</code> to determine if the service is running. If the return code is 0, its running. Otherwise, Chef checks the process table for a process running with the name of the service. </li>
<li> reload: Chef can only take the <code>reload</code> action for a service if it actually supports reload. </li>
<li> restart: When the <code>restart</code> action is sent to a service, if it supports restart then Chef will use <code>/etc/init.d/SERVICE_NAME restart</code>. Otherwise, Chef will use stop and start. </li>
</ul>
<p>Earlier when we wrote the template resources, we notified the service to reload. Since the resource supports reload, we can do this. Also note that the resource has an array of actions. Each of these actions will be taken if necessary when Chef manages it. In this case, it will be enabled at boot time, and then started if it is not already running.</p>
<h2>Let's Use the Recipe</h2>
<p>Now that we've written a nice recipe and understand what it's about to do, let's actually use it on a node we'd like to have smartmontools. Before uploading, I remove the boilerplate directories that were created by knife. The actual cookbook contents for upload are:</p>
<div class="CodeRay">
  <div class="code"><pre>% tree cookbooks/smartmontools
cookbooks/smartmontools
├── README.md
├── attributes
│   └── default.rb
├── files
│   └── default
│       └── 10mail
├── metadata.rb
├── recipes
│   └── default.rb
└── templates
    └── default
        ├── smartd.conf.erb
        └── smartmontools.default.erb

6 directories, 7 files</pre></div>
</div>

<p>I didn't mention the metadata yet as I haven't modified it yet. The knife command will create a default metadata.rb file as mentioned before. It will also populate it with some boilerplate content. The main thing I'm going to modify is the version and the platforms supported.</p>
<p><script src="https://gist.github.com/1192349.js"></script></p>
<p>Now it is time to actually upload the cookbook and apply it to a node.</p>
<div class="CodeRay">
  <div class="code"><pre>% knife cookbook upload smartmontools
Uploading smartmontools             [0.5.0]
upload complete

% knife node run list add virt1test 'recipe[smartmontools]'
run_list:
    role[ubuntu]
    recipe[smartmontools]</pre></div>
</div>

<h2>Run Chef</h2>
<p>I'll use <a href="http://wiki.opscode.com/display/chef/Knife#Knife-SSHSubcommand" name="knife ssh">knife ssh</a> to run chef-client on the nodes that have the smartmontools recipe applied.</p>
<p><script src="https://gist.github.com/1239999.js"></script></p>
<h2>Verify results</h2>
<p>We can verify the results of running the recipe by examining the resources on the target system(s). Chef's contract with you is that it will configure the resources in the manner specified in the recipe. You can be confident that it will completely configure every resource if it exits cleanly (which it did from the output above).</p>
<div class="CodeRay">
  <div class="code"><pre>% cat /etc/default/smartmontools
...
start_smartd=yes
...
% cat /etc/smartd.conf
...
DEVICESCAN -m root -M exec /usr/share/smartmontools/smartd-runner
...
% sudo service smartmontools status
 * smartd is running</pre></div>
</div>

<p>Now we can take this same recipe and apply it to other systems. I tested smartmontools on an Ubuntu system. Notice earlier that I had an <code>ubuntu</code> role on my node. I actually modified that role to include the smartmontools recipe, and then all my Ubuntu nodes were configured for smartmontools when they ran Chef again.</p>
<h2>Conclusion</h2>
<p>I hope this guide was helpful. I shared the cookbook on the <a href="http://community.opscode.com/cookbooks/smartmontools" name="Chef Community: Smartmontools">Chef Community web site</a>, and the source code is available on <a href="https://github.com/jtimberman/smartmontools-cookbook" name="GitHub">Chef Community web site</a>. Note that while I said this would be easy, it certainly isn't trivial. There are a lot of steps involved in making cookbooks that are dynamic, easily customized and shareable with others. It takes practice, but after a few you get the hang of it. End to end, this cookbook took me about 2 hours to write, test, tweak (fix bugs) and document.</p>
