<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>load_current_resource and chef-shell | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="load_current_resource and chef-shell" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This post will illustrate load_current_resource and a basic use of chef-shell." />
<meta property="og:description" content="This post will illustrate load_current_resource and a basic use of chef-shell." />
<link rel="canonical" href="/blog/2014/07/21/load-current-resource-and-chef-shell" />
<meta property="og:url" content="/blog/2014/07/21/load-current-resource-and-chef-shell" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-07-21T15:50:56+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="load_current_resource and chef-shell" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"This post will illustrate load_current_resource and a basic use of chef-shell.","url":"/blog/2014/07/21/load-current-resource-and-chef-shell","headline":"load_current_resource and chef-shell","@type":"BlogPosting","dateModified":"2014-07-21T15:50:56+00:00","datePublished":"2014-07-21T15:50:56+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2014/07/21/load-current-resource-and-chef-shell"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">load_current_resource and chef-shell</h1>
    <p class="post-meta"><time class="dt-published" datetime="2014-07-21T15:50:56+00:00" itemprop="datePublished">
        Jul 21, 2014
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This post will illustrate <code class="language-plaintext highlighter-rouge">load_current_resource</code> and a basic use of chef-shell.</p>

<p>The <code class="language-plaintext highlighter-rouge">chef-shell</code> is an <code class="language-plaintext highlighter-rouge">irb</code>-based <a href="http://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL (read-eval-print-loop)</a>. Everything I do is Ruby code, just like in Chef recipes or other cookbook components. I’m going to use a <code class="language-plaintext highlighter-rouge">package</code> resource example, so need privileged access (<code class="language-plaintext highlighter-rouge">sudo</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% sudo chef-shell
</code></pre></div></div>

<p>The chef-shell program loads its configuration, determines what session type, and displays a banner. In this case, we’re taking all the defaults, which means no special configuration, and a <code class="language-plaintext highlighter-rouge">standalone</code> session.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>loading configuration: none (standalone session)
Session type: standalone
Loading...done.

This is the chef-shell.
 Chef Version: 11.14.0.rc.2
 http://www.opscode.com/chef
 http://docs.opscode.com/

run `help' for help, `exit' or ^D to quit.

Ohai2u jtimberman@jenkins.int.housepub.org!
</code></pre></div></div>

<p>To evaluate resources as we’d write them in a recipe, we need to switch to recipe mode.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef &gt; recipe_mode
</code></pre></div></div>

<p>I can do anything here that I can do in a recipe. I could paste in my own recipes. Here, I’m just going to add a <code class="language-plaintext highlighter-rouge">package</code> resource to manage the <code class="language-plaintext highlighter-rouge">vim</code> package. Note that this works like the “compile” phase of a <code class="language-plaintext highlighter-rouge">chef-client</code> run. The resource will be added to the <code class="language-plaintext highlighter-rouge">Chef::ResourceCollection</code> object. We’ll look at this in a little more detail shortly.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; package "vim"
 =&gt; &lt;package[vim] @name: "vim" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :install, :upgrade, :remove, :purge, :reconfig] @action: :install @updated: false @updated_by_last_action: false @supports: {} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: "(irb#1):1:in `irb_binding'" @guard_interpreter: :default @elapsed_time: 0 @sensitive: false @candidate_version: nil @options: nil @package_name: "vim" @resource_name: :package @response_file: nil @response_file_variables: {} @source: nil @version: nil @timeout: 900 @cookbook_name: nil @recipe_name: nil&gt;
</code></pre></div></div>

<p>I’m done adding resources/writing code to test, so I’ll initiate a Chef run with the <code class="language-plaintext highlighter-rouge">run_chef</code> method (this is a special method in <code class="language-plaintext highlighter-rouge">chef-shell</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; run_chef
[2014-07-21T09:04:51-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)
[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] checking package status for vim
vim:
  Installed: 2:7.4.335-1
  Candidate: 2:7.4.335-1
  Version table:
 *** 2:7.4.335-1 0
        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
        100 /var/lib/dpkg/status
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] current version is 2:7.4.335-1
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] is already installed - nothing to do
</code></pre></div></div>

<p>Let’s take a look at what’s happening. Note that we have INFO and DEBUG output. By default, <code class="language-plaintext highlighter-rouge">chef-shell</code> runs with <code class="language-plaintext highlighter-rouge">Chef::Log#level</code> set to <code class="language-plaintext highlighter-rouge">:debug</code>. In a normal Chef Client run with <code class="language-plaintext highlighter-rouge">:info</code> output, we see the first line, but not the others. I’ll show each line, and then explain what Chef did.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:04:51-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)
</code></pre></div></div>

<p>There is a timestamp, the resource, <code class="language-plaintext highlighter-rouge">package[vim]</code>, the action <code class="language-plaintext highlighter-rouge">install</code> Chef will take, and the location in the recipe where this was encountered. I didn’t specify one in the resource, that’s the default action for package resources. The <code class="language-plaintext highlighter-rouge">irb#1 line 1</code> just means that it was the first line of the <code class="language-plaintext highlighter-rouge">irb</code> in recipe mode.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
</code></pre></div></div>

<p>Chef chooses the default provider for each resource based on a mapping of platforms and their versions. It uses an internal class, <code class="language-plaintext highlighter-rouge">Chef::Version::Comparable</code> to do this. The system I’m using is a Debian “testing” system, which has the codename <code class="language-plaintext highlighter-rouge">jessie</code>, but it isn’t a specific release number. Chef knows that for all <code class="language-plaintext highlighter-rouge">debian</code> platforms to use the <code class="language-plaintext highlighter-rouge">apt</code> package provider, and that’ll do here.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] checking package status for vim
vim:
  Installed: 2:7.4.335-1
  Candidate: 2:7.4.335-1
  Version table:
 *** 2:7.4.335-1 0
        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
        100 /var/lib/dpkg/status
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] current version is 2:7.4.335-1
[2014-07-21T09:04:51-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1
</code></pre></div></div>

<p>This output is the <code class="language-plaintext highlighter-rouge">load_current_resource</code> method implemented in the <a href="https://github.com/opscode/chef/blob/c507822d7b3fe0b34d02719dea0ab483ec292195/lib/chef/provider/package/apt.rb#L33-L38">apt package provider</a>.</p>

<p>The <code class="language-plaintext highlighter-rouge">check_package_state</code> method does all the heavy lifting. It runs <code class="language-plaintext highlighter-rouge">apt-cache policy</code> and parses the output looking for the version number. If we used the <code class="language-plaintext highlighter-rouge">:update</code> action, and the installed version wasn’t the same as the candidate version, Chef would install the candidate version.</p>

<p>Chef resources are convergent. They only get updated if they need to be. In this case, the <code class="language-plaintext highlighter-rouge">vim</code> package is installed already (our implicitly specified action), so we see the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] is already installed - nothing to do
</code></pre></div></div>

<p>Nothing to do, Chef finishes its run.</p>

<h2 id="modifying-existing-resources">Modifying Existing Resources</h2>

<p>We can manipulate the state of the resources in the resource collection. This isn’t common in most recipes. It’s required for certain kinds of development patterns like “wrapper” cookbooks. As an example, I’m going to modify the resource object so I don’t have to log into the system again and run <code class="language-plaintext highlighter-rouge">apt-get remove vim</code>, to show the next section.</p>

<p>First, I’m going to create a local variable in the context of the recipe. This is just like any other variable in Ruby. For its value, I’m going to use the <code class="language-plaintext highlighter-rouge">#resources()</code> <a href="http://docs.opscode.com/chef/dsl_recipe.html#resources">method to look up</a> a resource in the resource collection.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; local_package_variable = resources("package[vim]")
 =&gt; &lt;package[vim] @name: "vim" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :install, :upgrade, :remove, :purge, :reconfig] @action: :install @updated: false @updated_by_last_action: false @supports: {} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: "(irb#1):1:in `irb_binding'" @guard_interpreter: :default @elapsed_time: 0.029617095 @sensitive: false @candidate_version: nil @options: nil @package_name: "vim" @resource_name: :package @response_file: nil @response_file_variables: {} @source: nil @version: nil @timeout: 900 @cookbook_name: nil @recipe_name: nil&gt;
</code></pre></div></div>

<p>The return value is the package resource object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; local_package_variable.class
 =&gt; Chef::Resource::Package
</code></pre></div></div>

<p>(<code class="language-plaintext highlighter-rouge">#class</code> is a method on the Ruby <code class="language-plaintext highlighter-rouge">Object</code> class that returns the class of the object)</p>

<p>To remove the <code class="language-plaintext highlighter-rouge">vim</code> package, I use the <code class="language-plaintext highlighter-rouge">#run_action</code> method (available to all <code class="language-plaintext highlighter-rouge">Chef::Resource</code> subclasses), specifying the <code class="language-plaintext highlighter-rouge">:remove</code> action as a symbol:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; local_package_variable.run_action(:remove)
[2014-07-21T09:11:50-06:00] INFO: Processing package[vim] action remove ((irb#1) line 1)
[2014-07-21T09:11:52-06:00] INFO: package[vim] removed
</code></pre></div></div>

<p>There is no additional debug to display. Chef will run <code class="language-plaintext highlighter-rouge">apt-get remove vim</code> to converge the resource with this action.</p>

<h2 id="load-current-resource-redux">Load Current Resource Redux</h2>

<p>Now that the package has been removed from the system, what happens if we run Chef again? Well, Chef is convergent, and it takes idempotent actions on the system to ensure that the managed resources are in the desired state. That means it will install the <code class="language-plaintext highlighter-rouge">vim</code> package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef:recipe &gt; run_chef
[2014-07-21T09:11:57-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)
</code></pre></div></div>

<p>We’ll see some familiar messages here about the version, then:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:11:57-06:00] DEBUG: package[vim] checking package status for vim
vim:
  Installed: (none)
  Candidate: 2:7.4.335-1
  Version table:
     2:7.4.335-1 0
        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
[2014-07-21T09:11:57-06:00] DEBUG: package[vim] current version is nil
[2014-07-21T09:11:57-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1
</code></pre></div></div>

<p>This is <code class="language-plaintext highlighter-rouge">load_current_resource</code> working as expected. As we can see from the <code class="language-plaintext highlighter-rouge">apt-cache policy</code> output, the package is not installed, and as the action to take is <code class="language-plaintext highlighter-rouge">:install</code>, Chef will do what we think:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Reading package lists...
Building dependency tree...
Reading state information...
The following packages were automatically installed and are no longer required:
  g++-4.8 geoclue geoclue-hostip geoclue-localnet geoclue-manual
  geoclue-nominatim gstreamer0.10-plugins-ugly libass4 libblas3gf libcolord1
  libcolorhug1 libgeoclue0 libgnustep-base1.22 libgnutls28 libminiupnpc8
  libpoppler44 libqmi-glib0 libstdc++-4.8-dev python3-ply xulrunner-29
Use 'apt-get autoremove' to remove them.
Suggested packages:
  vim-doc vim-scripts
The following NEW packages will be installed:
  vim
0 upgraded, 1 newly installed, 0 to remove and 28 not upgraded.
Need to get 0 B/905 kB of archives.
After this operation, 2,088 kB of additional disk space will be used.
Selecting previously unselected package vim.
(Reading database ... 220338 files and directories currently installed.)
Preparing to unpack .../vim_2%3a7.4.335-1_amd64.deb ...
Unpacking vim (2:7.4.335-1) ...
Setting up vim (2:7.4.335-1) ...
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vim (vim) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vimdiff (vimdiff) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rvim (rvim) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rview (rview) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vi (vi) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/view (view) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/ex (ex) in auto mode
</code></pre></div></div>

<p>This should be familiar to anyone that uses Debian/Ubuntu, it’s standard <code class="language-plaintext highlighter-rouge">apt-get install</code> output. Of course, this is a development system so I have some cruft, but we’ll ignore that ;).</p>

<p>If we run_chef again, we get the output we saw in the original example in this post:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2014-07-21T09:50:06-06:00] DEBUG: package[vim] is already installed - nothing to do
</code></pre></div></div>

  </div><a class="u-url" href="/blog/2014/07/21/load-current-resource-and-chef-shell" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
