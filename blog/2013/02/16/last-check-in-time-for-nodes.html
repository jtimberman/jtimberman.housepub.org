<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Last Check-in Time for Nodes | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Last Check-in Time for Nodes" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This one liner uses the knife exec sub-command to iterate over all the node objects on the Chef Server, and print out their ohai_time attribute in a human readable format." />
<meta property="og:description" content="This one liner uses the knife exec sub-command to iterate over all the node objects on the Chef Server, and print out their ohai_time attribute in a human readable format." />
<link rel="canonical" href="/blog/2013/02/16/last-check-in-time-for-nodes" />
<meta property="og:url" content="/blog/2013/02/16/last-check-in-time-for-nodes" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-02-16T20:14:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Last Check-in Time for Nodes" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"This one liner uses the knife exec sub-command to iterate over all the node objects on the Chef Server, and print out their ohai_time attribute in a human readable format.","url":"/blog/2013/02/16/last-check-in-time-for-nodes","headline":"Last Check-in Time for Nodes","@type":"BlogPosting","dateModified":"2013-02-16T20:14:00+00:00","datePublished":"2013-02-16T20:14:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2013/02/16/last-check-in-time-for-nodes"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Last Check-in Time for Nodes</h1>
    <p class="post-meta"><time class="dt-published" datetime="2013-02-16T20:14:00+00:00" itemprop="datePublished">
        Feb 16, 2013
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This one liner uses the knife exec sub-command to iterate over all the
node objects on the Chef Server, and print out their <code class="language-plaintext highlighter-rouge">ohai_time</code>
attribute in a human readable format.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>knife exec -E 'nodes.all {|n| puts "#{n.name} #{Time.at(n[:ohai_time])}"}'
</code></pre></div></div>

<p>Let’s break this up a little.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>knife exec -E
</code></pre></div></div>

<p>The exec plugin for knife executes a script or the given string of
Ruby code in the same context as <code class="language-plaintext highlighter-rouge">chef-shell</code> (or <code class="language-plaintext highlighter-rouge">shef</code> in Chef 10
and earlier) if you start it up in it’s “main” context. Since it is
knife, it will also use your <code class="language-plaintext highlighter-rouge">.chef/knife.rb</code> settings, so it knows
about your user, key and Chef Server.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nodes.all
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">chef-shell</code> main context has helper methods to access the
corresponding endpoints in the Chef Server API. Clearly we’re working
with “nodes” here, and the <code class="language-plaintext highlighter-rouge">#all</code> method returns all the node objects
from the Chef Server. This differs from search in that there’s a
commit delay between the time when data is saved to the server, and
the data is indexed by Solr. This is usually a few seconds, but
depending on various factors like the hardware you’re using, how many
nodes are converging, etc, it can take longer.</p>

<p>Anyway, we can pass a block to nodes.all and do something with each
node object. The example above is a oneliner, so let’s make it more
readable.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nodes</span><span class="p">.</span><span class="nf">all</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">n</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="ss">:ohai_time</span><span class="p">])</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We’re simply going to use <code class="language-plaintext highlighter-rouge">n</code> as the iterator for each node object,
and we’ll print a string about the node. The <code class="language-plaintext highlighter-rouge">#{}</code>’s in the string to
print with puts is Ruby string interpolation. That is, everything
inside the braces is a Ruby expression. First, the <code class="language-plaintext highlighter-rouge">Chef::Node</code> object
has a method, <code class="language-plaintext highlighter-rouge">#name</code>, that returns the node’s name. This is usually
the FQDN, but depending on your configuration (<code class="language-plaintext highlighter-rouge">node_name</code> in
<code class="language-plaintext highlighter-rouge">/etc/chef/client.rb</code> or using the <code class="language-plaintext highlighter-rouge">-N</code> option for <code class="language-plaintext highlighter-rouge">chef-client</code>), it
could be something else. Then, we’re going to use the node’s
<code class="language-plaintext highlighter-rouge">ohai_time</code> attribute. Every time Chef runs and it gathers data about
the node with Ohai, it generates the <code class="language-plaintext highlighter-rouge">ohai_time</code> attribute, which is
the Unix epoch of the timestamp when Ohai ran. When Chef saves the
node data at the end of the run, we know approximately the last time
the node ran Chef. In this particular string, we’re converting the
Unix epoch, like <code class="language-plaintext highlighter-rouge">1358962351.444405</code> to a human readable timestamp
like <code class="language-plaintext highlighter-rouge">2013-01-23 10:32:31 -0700</code>.</p>

<p>Of course, you can get similar data from the Chef Server by using
<code class="language-plaintext highlighter-rouge">knife status</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>knife status
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">ohai_time</code> attribute will be displayed as a relative time, e.g.,
“585 hours ago.” It will include some more data about the nodes like IP’s. This
uses Chef’s search feature, so you can also pass in a query:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>knife status "role:webserver"
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">knife exec</code> example is simple, but you can get a lot more data
about the nodes than what <code class="language-plaintext highlighter-rouge">knife status</code> reports.</p>

<p>In either case, <code class="language-plaintext highlighter-rouge">ohai_time</code> isn’t 100% accurate, since it is generated
at the beginning of the run, and depending on what you’re doing with
Chef on your systems, it can take a long time before the node data is
saved. However, it’s close enough for many use cases.</p>

<p>If more detailed or completely accurate information about the Chef run
is required for your purposes, you should use a
<a href="http://docs.opscode.com/chef/essentials_handlers.html">report handler</a>,
which does have more data about the run available, including whether
the run was successful or not.</p>

  </div><a class="u-url" href="/blog/2013/02/16/last-check-in-time-for-nodes" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
