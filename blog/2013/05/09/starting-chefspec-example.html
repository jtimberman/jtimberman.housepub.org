<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Starting ChefSpec Example | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Starting ChefSpec Example" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is a quick post to introduce what I’m starting on testing with ChefSpec. This is from Opscode’s Java cookbook. While the recipe tested is really trivial, it actually has some nuances that require detailed testing." />
<meta property="og:description" content="This is a quick post to introduce what I’m starting on testing with ChefSpec. This is from Opscode’s Java cookbook. While the recipe tested is really trivial, it actually has some nuances that require detailed testing." />
<link rel="canonical" href="/blog/2013/05/09/starting-chefspec-example" />
<meta property="og:url" content="/blog/2013/05/09/starting-chefspec-example" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-05-09T21:10:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Starting ChefSpec Example" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"This is a quick post to introduce what I’m starting on testing with ChefSpec. This is from Opscode’s Java cookbook. While the recipe tested is really trivial, it actually has some nuances that require detailed testing.","url":"/blog/2013/05/09/starting-chefspec-example","headline":"Starting ChefSpec Example","@type":"BlogPosting","dateModified":"2013-05-09T21:10:00+00:00","datePublished":"2013-05-09T21:10:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2013/05/09/starting-chefspec-example"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Starting ChefSpec Example</h1>
    <p class="post-meta"><time class="dt-published" datetime="2013-05-09T21:10:00+00:00" itemprop="datePublished">
        May 9, 2013
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is a quick post to introduce what I’m starting on testing with
<a href="http://acrmp.github.io/chefspec/">ChefSpec</a>. This is from Opscode’s
Java cookbook. While the recipe tested is really trivial, it actually
has some nuances that require detailed testing.</p>

<p>First off, the whole thing is in
<a href="https://gist.github.com/jtimberman/5552182">this gist</a>. I’m going to
break it down into sections below. The file is <code class="language-plaintext highlighter-rouge">spec/default_spec.rb</code>
in the java cookbook (not committed/pushed yet).</p>

<p>The chefspec gem is where all the magic comes from. You can read about
ChefSpec on <a href="http://acrmp.github.io/chefspec/">its home page</a>. You’ll
need to install the gem, and from there, run <code class="language-plaintext highlighter-rouge">rspec</code> to run the tests.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'chefspec'</span>
</code></pre></div></div>

<p>Next, we’re going to describe the default recipe. We’re using the
regular rspec “let” block to set up the runner to converge the recipe.
Then, because we know/assume that the openjdk recipe is the default,
we can say that this chef run should include the <code class="language-plaintext highlighter-rouge">java::openjdk</code> recipe.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s1">'java::default'</span> <span class="k">do</span>
  <span class="n">let</span> <span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="p">{</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">converge</span><span class="p">(</span><span class="s1">'java::default'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="s1">'should include the openjdk recipe by default'</span> <span class="k">do</span>
    <span class="n">chef_run</span><span class="p">.</span><span class="nf">should</span> <span class="n">include_recipe</span> <span class="s1">'java::openjdk'</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Next, this cookbook supports Windows. However, we have to set up the
runner with the correct platform and version (this comes from
<a href="https://github.com/customink/fauxhai">fauxhai</a>), and then set
attributes that are required for it to work.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span> <span class="s1">'windows'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
        <span class="s1">'platform'</span> <span class="o">=&gt;</span> <span class="s1">'windows'</span><span class="p">,</span>
        <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="s1">'2008R2'</span>
        <span class="p">)</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'install_flavor'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'windows'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'windows'</span><span class="p">][</span><span class="s1">'url'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'http://example.com/windows-java.msi'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">converge</span><span class="p">(</span><span class="s1">'java::default'</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="s1">'should include the windows recipe'</span> <span class="k">do</span>
      <span class="n">chef_run</span><span class="p">.</span><span class="nf">should</span> <span class="n">include_recipe</span> <span class="s1">'java::windows'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Next are the contexts for other install flavors. The default recipe
will include the right recipe based on the flavor, which is set by an
attribute. So we set up an rspec context for each recipe, then set the
install flavor attribute, and test that the right recipe was included.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">context</span> <span class="s1">'oracle'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'install_flavor'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'oracle'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">converge</span><span class="p">(</span><span class="s1">'java::default'</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="s1">'should include the oracle recipe'</span> <span class="k">do</span>
      <span class="n">chef_run</span><span class="p">.</span><span class="nf">should</span> <span class="n">include_recipe</span> <span class="s1">'java::oracle'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">context</span> <span class="s1">'oracle_i386'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'install_flavor'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'oracle_i386'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">converge</span><span class="p">(</span><span class="s1">'java::default'</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="s1">'should include the oracle_i386 recipe'</span> <span class="k">do</span>
      <span class="n">chef_run</span><span class="p">.</span><span class="nf">should</span> <span class="n">include_recipe</span> <span class="s1">'java::oracle_i386'</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Finally, a recent addition to this cookbook is support for
<a href="http://tickets.opscode.com/browse/COOK-2897">IBM’s Java</a>. In addition
to setting the install flavor, we must set the URL where the IBM Java
package is (see the README in the commit linked in that ticket for
detail), and we can see that the <code class="language-plaintext highlighter-rouge">ibm</code> recipe is in fact included.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">context</span> <span class="s1">'ibm'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'install_flavor'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'ibm'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'java'</span><span class="p">][</span><span class="s1">'ibm'</span><span class="p">][</span><span class="s1">'url'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'http://example.com/ibm-java.bin'</span>
      <span class="n">runner</span><span class="p">.</span><span class="nf">converge</span><span class="p">(</span><span class="s1">'java::default'</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">it</span> <span class="s1">'should include the ibm recipe'</span> <span class="k">do</span>
      <span class="n">chef_run</span><span class="p">.</span><span class="nf">should</span> <span class="n">include_recipe</span> <span class="s1">'java::ibm'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is just the start of the testing for this cookbook. We’ll need to
test each individual recipe. However as I’ve not written that code
yet, I don’t have examples. Stay tuned!</p>

  </div><a class="u-url" href="/blog/2013/05/09/starting-chefspec-example" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
