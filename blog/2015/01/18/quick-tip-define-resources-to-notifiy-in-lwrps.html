<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Quick Tip: Define Resources to Notifiy in LWRPs | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Quick Tip: Define Resources to Notifiy in LWRPs" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this quick tip, I’ll explain why you may need to create resources to notify in a provider, even if the resource exists in a recipe, when using use_inline_resources in Chef’s LWRP DSL." />
<meta property="og:description" content="In this quick tip, I’ll explain why you may need to create resources to notify in a provider, even if the resource exists in a recipe, when using use_inline_resources in Chef’s LWRP DSL." />
<link rel="canonical" href="/blog/2015/01/18/quick-tip-define-resources-to-notifiy-in-lwrps" />
<meta property="og:url" content="/blog/2015/01/18/quick-tip-define-resources-to-notifiy-in-lwrps" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-18T05:37:06+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Quick Tip: Define Resources to Notifiy in LWRPs" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"In this quick tip, I’ll explain why you may need to create resources to notify in a provider, even if the resource exists in a recipe, when using use_inline_resources in Chef’s LWRP DSL.","url":"/blog/2015/01/18/quick-tip-define-resources-to-notifiy-in-lwrps","headline":"Quick Tip: Define Resources to Notifiy in LWRPs","@type":"BlogPosting","dateModified":"2015-01-18T05:37:06+00:00","datePublished":"2015-01-18T05:37:06+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2015/01/18/quick-tip-define-resources-to-notifiy-in-lwrps"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Quick Tip: Define Resources to Notifiy in LWRPs</h1>
    <p class="post-meta"><time class="dt-published" datetime="2015-01-18T05:37:06+00:00" itemprop="datePublished">
        Jan 18, 2015
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In this quick tip, I’ll explain why you may need to create resources to notify in a provider, even if the resource exists in a recipe, when using <code class="language-plaintext highlighter-rouge">use_inline_resources</code> in Chef’s <a href="http://docs.chef.io/lwrp.html">LWRP DSL</a>.</p>

<p>I’ll use an example cookbook, <code class="language-plaintext highlighter-rouge">notif</code>, to illustrate. First, I’ve created <code class="language-plaintext highlighter-rouge">cookbooks/notif/resources/default.rb</code>, with the following content.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">actions</span> <span class="ss">:write</span>
<span class="n">default_action</span> <span class="ss">:write</span>
</code></pre></div></div>

<p>Then, I have written <code class="language-plaintext highlighter-rouge">cookbooks/notif/providers/default.rb</code> like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use_inline_resources</span>

<span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
  <span class="n">log</span> <span class="s1">'notifer'</span> <span class="k">do</span>
    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">'file[notified]'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then the default recipe, where I’ll use the resource automatically generated from the resource directory, <code class="language-plaintext highlighter-rouge">notif</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span> <span class="s1">'notified'</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s1">'something'</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">notif</span> <span class="s1">'doer'</span>
</code></pre></div></div>

<p>When I run Chef, I’ll get an error like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Recipe: notif::default
   * file[notified] action nothing (skipped due to action :nothing)
   * notif[doer] action write

     ================================================================================
     Error executing action `write` on resource 'notif[doer]'
     ================================================================================

     Chef::Exceptions::ResourceNotFound
     ----------------------------------
     resource log[notifer] is configured to notify resource file[notified] with action create, but file[notified] cannot be found in the resource collection. log[notifer] is defined in /tmp/kitchen/cookbooks/notif/providers/default.rb:4:in `block in class_from_file'

     Resource Declaration:
     ---------------------
     # In /tmp/kitchen/cookbooks/notif/recipes/default.rb

      12: notif 'doer'

     Compiled Resource:
 ------------------
     # Declared in /tmp/kitchen/cookbooks/notif/recipes/default.rb:12:in `from_file'

     notif("doer") do
       action :write
       retries 0
       retry_delay 2
       default_guard_interpreter :default
       declared_type :notif

       recipe_name "default"
     end
</code></pre></div></div>

<p>To fix this, I define the <code class="language-plaintext highlighter-rouge">file</code> resource in the provider:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use_inline_resources</span>

<span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
  <span class="n">log</span> <span class="s1">'notifer'</span> <span class="k">do</span>
    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">'file[notified]'</span>
  <span class="k">end</span>

  <span class="n">file</span> <span class="s1">'notified'</span> <span class="k">do</span>
    <span class="n">content</span> <span class="n">new_resource</span><span class="p">.</span><span class="nf">name</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then when I run Chef, it will converge and notify the file resource to be configured.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Recipe: notif::default
  * file[notified] action nothing (skipped due to action :nothing)
  * notif[doer] action write
    * log[notifer] action write

    * file[notified] action create
      - create new file notified
      - update content in file notified from none to 935e8e
      --- notified       2015-01-18 05:47:49.186399317 +0000
      +++ ./.notified20150118-15795-om5fiw       2015-01-18 05:47:49.186399317 +0000
      @@ -1 +1,2 @@
      +doer
    * file[notified] action create (up to date)

Running handlers:
Running handlers complete
Chef Client finished, 3/4 resources updated in 1.298990565 seconds
</code></pre></div></div>

<h2 id="why-does-this-happen">Why does this happen?</h2>

<p>The reason for this is because <code class="language-plaintext highlighter-rouge">use_inline_resources</code> tells Chef that in this provider, we’re using inline resources that will be added to their own run context, with their own resource collection. We don’t have access to the resource collection from the recipe. Even though the <code class="language-plaintext highlighter-rouge">file[notified]</code> resource exists from the recipe, it doesn’t actually get inherited in the provider’s run context, raising the error we saw before.</p>

<p>We can turn off <code class="language-plaintext highlighter-rouge">use_inline_resources</code> by removing it, and the custom resource will be configured:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
  <span class="n">log</span> <span class="s1">'notifer'</span> <span class="k">do</span>
    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">'file[notified]'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then run Chef:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Recipe: notif::default
  * file[notified] action nothing (skipped due to action :nothing)
  * notif[doer] action write (up to date)
  * log[notifer] action write
  * file[notified] action create
    - update content in file notified from 935e8e to 3fc9b6
    --- notified 2015-01-18 05:47:49.186399317 +0000
    +++ ./.notified20150118-16159-r18q7z 2015-01-18 05:50:57.832140405 +0000
    @@ -1,2 +1,2 @@
    -doer
    +something
</code></pre></div></div>

<p>Notice that the <code class="language-plaintext highlighter-rouge">file[notified]</code> resource wasn’t updated at the start of the run, when it was encountered in the recipe, but it was when notified by the log resource in the provider action, changing the content.</p>

<h2 id="use-inline-compile-mode">Use inline compile mode!</h2>

<p>The <code class="language-plaintext highlighter-rouge">use_inline_resources</code> method in the lightweight provider DSL is strongly recommended. It makes it easier to send notifications from the custom resource itself to other resources in the recipe’s resource collection. Read more about the <a href="http://docs.chef.io/lwrp.html#inline-compile-mode">inline compile mode</a> in the Chef docs.</p>

<p>Also, define the resources that you need to notify when you’re doing this in your provider’s actions. A common example is within a provider that writes configuration for a service, and needs to tell that service to restart.</p>

  </div><a class="u-url" href="/blog/2015/01/18/quick-tip-define-resources-to-notifiy-in-lwrps" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
