<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Quick Tip: Testing Conditionals in ChefSpec | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Quick Tip: Testing Conditionals in ChefSpec" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This tip is brought to you by the homebrew cookbook." />
<meta property="og:description" content="This tip is brought to you by the homebrew cookbook." />
<link rel="canonical" href="/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec" />
<meta property="og:url" content="/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-01-12T21:07:06+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Quick Tip: Testing Conditionals in ChefSpec" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"This tip is brought to you by the homebrew cookbook.","url":"/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec","headline":"Quick Tip: Testing Conditionals in ChefSpec","@type":"BlogPosting","dateModified":"2015-01-12T21:07:06+00:00","datePublished":"2015-01-12T21:07:06+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Quick Tip: Testing Conditionals in ChefSpec</h1>
    <p class="post-meta"><time class="dt-published" datetime="2015-01-12T21:07:06+00:00" itemprop="datePublished">
        Jan 12, 2015
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This tip is brought to you by the <a href="https://supermarket.chef.io/cookbooks/homebrew">homebrew</a> cookbook.</p>

<p><a href="http://sethvargo.github.io/chefspec/">ChefSpec</a> is a great way to create tests for Chef recipes to catch regressions. Sometimes recipes end up having branching conditional logic that can have very different outcomes based on external factors - attributes, existing system state, or cross-platform support.</p>

<p>The homebrew cookbook only supports OS X, so we don’t have cross-platform support to test there. However, its default recipe has four conditionals to test. You can read the entire <a href="https://github.com/opscode-cookbooks/homebrew/blob/master/spec/recipes/default_spec.rb">default_spec.rb</a> for full context, I’m going to focus on just one aspect here:</p>

<ul>
  <li>Installing homebrew should only happen if the <code class="language-plaintext highlighter-rouge">brew</code> binary does not exist.</li>
</ul>

<p>This is a common use case in Chef recipes. The best way to go about converging your node to the desired state involves running some arbitrary command. In this case, it’s the installation of Homebrew itself. Normally for installations we want to use an idempotent, convergent resource like <code class="language-plaintext highlighter-rouge">package</code>. However, since homebrew is to be our package management system, we have to do something else. As it turns out the homebrew project provides an installation script and that script will install a binary, <code class="language-plaintext highlighter-rouge">/usr/local/bin/brew</code>. We will assume that if Chef converged on a node after running the script, and the <code class="language-plaintext highlighter-rouge">brew</code> binary exists, then we don’t need to attempt reinstallation. There’s more robust ways to go about it (e.g., running <code class="language-plaintext highlighter-rouge">brew</code> gives some desired output), but this works for example purposes today.</p>

<p>From <a href="https://github.com/opscode-cookbooks/homebrew/blob/master/recipes/default.rb">the recipe</a>, here’s the resource:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute</span> <span class="s1">'install homebrew'</span> <span class="k">do</span>
  <span class="n">command</span> <span class="n">homebrew_go</span>
  <span class="n">user</span> <span class="n">node</span><span class="p">[</span><span class="s1">'homebrew'</span><span class="p">][</span><span class="s1">'owner'</span><span class="p">]</span> <span class="o">||</span> <span class="n">homebrew_owner</span>
  <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span> <span class="s1">'/usr/local/bin/brew'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">command</code> is a script, called <code class="language-plaintext highlighter-rouge">homebrew_go</code>, which is a local variable set to a path in <code class="language-plaintext highlighter-rouge">Chef::Config[:file_cache_path]</code>. It is retrieved in the recipe with <code class="language-plaintext highlighter-rouge">remote_file</code>. The resource used to have <code class="language-plaintext highlighter-rouge">execute homebrew_go</code>, but when ChefSpec runs, it does so in a random temporary directory, which we cannot predict the name.</p>

<p>The astute observer will note that the <code class="language-plaintext highlighter-rouge">user</code> parameter has another conditional (designated by the <code class="language-plaintext highlighter-rouge">||</code>). That’s actually the subject of another post. In this post, I’m concerned only with testing the guard, <code class="language-plaintext highlighter-rouge">not_if</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">not_if</code> is a Ruby block, which means the Ruby code is evaluated inline during the Chef run. How we go about testing that is the subject of this post.</p>

<p>First, we need to mock the return result of sending the <code class="language-plaintext highlighter-rouge">#exist?</code> method to the <code class="language-plaintext highlighter-rouge">File</code> class. There are two reasons. First, we want to control the conditional so we can write a test for each outcome. Second, someone running the test (like me) might have already installed homebrew on their local system (which I have), and so <code class="language-plaintext highlighter-rouge">/usr/local/bin/brew</code> will exist. To do this, in our context, we have a <code class="language-plaintext highlighter-rouge">before</code> block that stubs the return to false:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">Chef</span><span class="o">::</span><span class="no">Resource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:homebrew_owner</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="s1">'vagrant'</span><span class="p">)</span>
  <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">Chef</span><span class="o">::</span><span class="no">Recipe</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:homebrew_owner</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="s1">'vagrant'</span><span class="p">)</span>
  <span class="n">allow</span><span class="p">(</span><span class="no">File</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:exist?</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
  <span class="n">stub_command</span><span class="p">(</span><span class="s1">'which git'</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>There’s some other mocked values here. I’ll talk about the <code class="language-plaintext highlighter-rouge">vagrant</code> user for <code class="language-plaintext highlighter-rouge">homebrew_owner</code> in a moment, though again, that’s the subject of another post.</p>

<p>The actual spec will test that the installation script will actually get executed when we run chef, and as the <code class="language-plaintext highlighter-rouge">vagrant</code> user.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="s1">'runs homebrew installation as the default user'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">).</span><span class="nf">to</span> <span class="n">run_execute</span><span class="p">(</span><span class="s1">'install homebrew'</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span>
    <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="s1">'vagrant'</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When rspec runs, we see this is the case:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>homebrew::default
  default user
    runs homebrew installation as the default user
</code></pre></div></div>

<p>If I didn’t mock the user, it would be <code class="language-plaintext highlighter-rouge">jtimberman</code>, as that is the user that is running Chef via rspec/ChefSpec. The test would fail. If you’re looking at the full file, there’s some other details we’re going to look at shortly. If I didn’t mock the return for <code class="language-plaintext highlighter-rouge">File.exist?</code>, the execute wouldn’t run at all.</p>

<p>To test what happens when <code class="language-plaintext highlighter-rouge">/usr/local/bin/brew</code> exists, I set up a new context in rspec, and create a new <code class="language-plaintext highlighter-rouge">before</code> block.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span> <span class="s1">'/usr/local/bin/brew exists'</span> <span class="k">do</span>
  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="no">File</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:exist?</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="n">stub_command</span><span class="p">(</span><span class="s1">'which git'</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'does not run homebrew installation'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">run_execute</span><span class="p">(</span><span class="s1">'install homebrew'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We don’t need the <code class="language-plaintext highlighter-rouge">vagrant</code> mocks earlier, but we do need to stub <code class="language-plaintext highlighter-rouge">File.exist?</code>. This test would pass on my system without it, but not on, e.g., a Linux system that doesn’t have homebrew.</p>

<p>Then running rspec, we see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>homebrew::default
  /usr/local/bin/brew exists
    does not run homebrew installation
  default user
    runs homebrew installation as the default user
</code></pre></div></div>

<p>In a coming post, I will walk through the conditionals related to the <code class="language-plaintext highlighter-rouge">homebrew_owner</code>.</p>

  </div><a class="u-url" href="/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
