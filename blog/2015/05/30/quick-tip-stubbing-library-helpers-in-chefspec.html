<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Quick Tip: Stubbing Library Helpers in ChefSpec | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Quick Tip: Stubbing Library Helpers in ChefSpec" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’m currently updating my vagrant cookbook, and adding ChefSpec coverage. Each of the different platform recipes results in slightly different resources to download the package file and install it. To support this, I have helper methods that calculate the download URI, the package name, and the SHA256 checksum based on the version of Vagrant (node[&#39;vagrant&#39;][&#39;version&#39;]), and the platform (node[&#39;os&#39;], node[&#39;platform_family&#39;])." />
<meta property="og:description" content="I’m currently updating my vagrant cookbook, and adding ChefSpec coverage. Each of the different platform recipes results in slightly different resources to download the package file and install it. To support this, I have helper methods that calculate the download URI, the package name, and the SHA256 checksum based on the version of Vagrant (node[&#39;vagrant&#39;][&#39;version&#39;]), and the platform (node[&#39;os&#39;], node[&#39;platform_family&#39;])." />
<link rel="canonical" href="/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec" />
<meta property="og:url" content="/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-05-30T14:48:47+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Quick Tip: Stubbing Library Helpers in ChefSpec" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"I’m currently updating my vagrant cookbook, and adding ChefSpec coverage. Each of the different platform recipes results in slightly different resources to download the package file and install it. To support this, I have helper methods that calculate the download URI, the package name, and the SHA256 checksum based on the version of Vagrant (node[&#39;vagrant&#39;][&#39;version&#39;]), and the platform (node[&#39;os&#39;], node[&#39;platform_family&#39;]).","url":"/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec","headline":"Quick Tip: Stubbing Library Helpers in ChefSpec","@type":"BlogPosting","dateModified":"2015-05-30T14:48:47+00:00","datePublished":"2015-05-30T14:48:47+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Quick Tip: Stubbing Library Helpers in ChefSpec</h1>
    <p class="post-meta"><time class="dt-published" datetime="2015-05-30T14:48:47+00:00" itemprop="datePublished">
        May 30, 2015
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I’m currently updating my <a href="https://supermarket.chef.io/cookbooks/vagrant">vagrant cookbook</a>, and adding <a href="https://sethvargo.github.io/chefspec">ChefSpec</a> coverage. Each of the different platform recipes results in slightly different resources to download the package file and install it. To support this, I have <a href="https://github.com/jtimberman/vagrant-cookbook/blob/master/libraries/helpers.rb">helper methods</a> that calculate the download URI, the package name, and the SHA256 checksum based on the version of Vagrant (<code class="language-plaintext highlighter-rouge">node['vagrant']['version']</code>), and the platform (<code class="language-plaintext highlighter-rouge">node['os']</code>, <code class="language-plaintext highlighter-rouge">node['platform_family']</code>).</p>

<p>The outcomes I want to test are that for a given platform: the correct recipe is included, the correct file is downloaded, and the correct package resource installs the downloaded file. Those tests look like this (using Ubuntu/Debian example first):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">it</span> <span class="s1">'includes the debian platform family recipe'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">).</span><span class="nf">to</span> <span class="n">include_recipe</span><span class="p">(</span><span class="s1">'vagrant::debian'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s1">'downloads the package from the calculated URI'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">).</span><span class="nf">to</span> <span class="n">create_remote_file</span><span class="p">(</span><span class="s1">'/var/tmp/vagrant.deb'</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span>
    <span class="ss">source: </span><span class="s1">'https://dl.bintray.com/mitchellh/vagrant/vagrant_1.88.88_x86_64.deb'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s1">'installs the downloaded package'</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">).</span><span class="nf">to</span> <span class="n">install_dpkg_package</span><span class="p">(</span><span class="s1">'vagrant'</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span>
    <span class="ss">source: </span><span class="s1">'/var/tmp/vagrant.deb'</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I’ve set the version attribute in the <code class="language-plaintext highlighter-rouge">chef_run</code> block for the ChefSpec run to <code class="language-plaintext highlighter-rouge">1.88.88</code> to ensure that it doesn’t use the value set in the attributes file, and then I can test this specifically in the source for the calculated URI, even if the attribute changes - hopefully Vagrant doesn’t have a 1.88.88 version some day ;).</p>

<p>When I run <code class="language-plaintext highlighter-rouge">rspec spec</code>, I get exceptions, however.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1) vagrant::default debian includes the debian platform family recipe
   Failure/Error: end.converge(described_recipe)
   OpenURI::HTTPError:
     404 Not Found
</code></pre></div></div>

<p>This is because in the <code class="language-plaintext highlighter-rouge">attributes/default.rb</code>, the checksum is retrieved using the <code class="language-plaintext highlighter-rouge">vagrant_sha256sum</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">default</span><span class="p">[</span><span class="s1">'vagrant'</span><span class="p">][</span><span class="s1">'checksum'</span><span class="p">]</span> <span class="o">=</span> <span class="n">vagrant_sha256sum</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">'vagrant'</span><span class="p">][</span><span class="s1">'version'</span><span class="p">])</span>
</code></pre></div></div>

<p>The exception is happening when Chef loads the attributes file, and because the version is not valid. The solution here is to stub out the return value from <code class="language-plaintext highlighter-rouge">vagrant_sha256sum</code>. This can be anything at all really, because that specific attribute is to make sure we don’t have to re-download the package to <a href="http://docs.chef.io/resource_remote_file.html#attributes">compare its checksum</a> on later Chef runs. In this cookbook, the helper methods are not namespaced under a module, they’re bare methods in <code class="language-plaintext highlighter-rouge">libraries.helpers.rb</code>. This <a href="https://github.com/sethvargo/chefspec/issues/562">poses some</a> <a href="https://github.com/sethvargo/chefspec/issues/549">challenges</a> <a href="https://github.com/sethvargo/chefspec/issues/273">when trying</a> <a href="https://github.com/sethvargo/chefspec/issues/138">to stub</a> <a href="https://github.com/sethvargo/chefspec/issues/253">them</a> in ChefSpec. I won’t rehash all the ways I attempted to get this to work, and instead focus on the final solution that got the tests passing:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="no">Chef</span><span class="o">::</span><span class="no">Node</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:vagrant_sha256sum</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When Chef loads cookbook attributes files, it is evaluating them in the context of a <code class="language-plaintext highlighter-rouge">Chef::Node</code>, so those library helper methods are sent to the <code class="language-plaintext highlighter-rouge">Chef::Node</code> object. Similarly, if this were inside a recipe, I would use <code class="language-plaintext highlighter-rouge">Chef::Recipe</code>, and if it were inside a resource (e.g., <code class="language-plaintext highlighter-rouge">package</code>), <code class="language-plaintext highlighter-rouge">Chef::Resource</code>.</p>

<p>I put this <code class="language-plaintext highlighter-rouge">before</code> block at the <code class="language-plaintext highlighter-rouge">describe 'vagrant::default'</code> level, not within any <code class="language-plaintext highlighter-rouge">context</code> blocks, so it will be done for each of the various per-platform tests. The results in my <code class="language-plaintext highlighter-rouge">debian</code> context are now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% rspec spec --color -fd

vagrant::default
  debian
    includes the debian platform family recipe
    downloads the package from the calculated URI
    installs the downloaded package

Finished in 7.04 seconds (files took 7.93 seconds to load)
3 examples, 0 failures
</code></pre></div></div>

<p>Six issues have been filed against ChefSpec about this. Hopefully this can result in fewer inquiries.</p>

<p>Happy testing!</p>

  </div><a class="u-url" href="/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
