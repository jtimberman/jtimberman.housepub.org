<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Autostarted Services | jtimberman’s blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Autostarted Services" />
<meta name="author" content="Joshua Timberman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It is quite common in Debian and Ubuntu that when installing a package that provides a daemon, said daemon is started by the init script(s) included in the package. This is a matter of Debian Policy, though I don’t interpret that section to literally mean it is required. However, it is common enough practice that several people have asked (or ranted) about the topic." />
<meta property="og:description" content="It is quite common in Debian and Ubuntu that when installing a package that provides a daemon, said daemon is started by the init script(s) included in the package. This is a matter of Debian Policy, though I don’t interpret that section to literally mean it is required. However, it is common enough practice that several people have asked (or ranted) about the topic." />
<link rel="canonical" href="/blog/2012/07/26/autostarted-services" />
<meta property="og:url" content="/blog/2012/07/26/autostarted-services" />
<meta property="og:site_name" content="jtimberman’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-07-26T22:11:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Autostarted Services" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Joshua Timberman"},"description":"It is quite common in Debian and Ubuntu that when installing a package that provides a daemon, said daemon is started by the init script(s) included in the package. This is a matter of Debian Policy, though I don’t interpret that section to literally mean it is required. However, it is common enough practice that several people have asked (or ranted) about the topic.","url":"/blog/2012/07/26/autostarted-services","headline":"Autostarted Services","@type":"BlogPosting","dateModified":"2012-07-26T22:11:00+00:00","datePublished":"2012-07-26T22:11:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2012/07/26/autostarted-services"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="jtimberman's blog" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-26031299-1"></script>
<script>
  window['ga-disable-UA-26031299-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-26031299-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">jtimberman&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Autostarted Services</h1>
    <p class="post-meta"><time class="dt-published" datetime="2012-07-26T22:11:00+00:00" itemprop="datePublished">
        Jul 26, 2012
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>It is quite common in Debian and Ubuntu that when installing a package
that provides a daemon, said daemon is started by the init script(s)
included in the package. This is a matter of
<a href="http://www.debian.org/doc/debian-policy/ch-opersys.html#s-sysvinit">Debian Policy</a>,
though I don’t interpret that section to literally mean it is
required. However, it is
<a href="http://wiki.debian.org/LSBInitScripts/">common enough practice</a> that <a href="https://www.varnish-cache.org/trac/ticket/1004">several people</a>
have <a href="http://ask.debian.net/questions/how-to-prevent-daemons-from-starting-at-installation-time">asked</a> (or <a href="https://gist.github.com/1721727">ranted</a>) about <a href="http://lists.opscode.com/sympa/arc/chef-dev/2012-02/msg00017.html">the topic</a>.</p>

<p>The main issue of course is that the default configuration for the
software being installed may not be appropriate before starting up the
service and making it available on the network. Users of other Linux
distributions may be smugly smirking as their distribution doesn’t
start the service on package installation.</p>

<p>This post isn’t about that.</p>

<p>Instead, this post describes how this problem is resolved using
configuration management, specifically Chef. I’m also going to discuss
a couple nuances about service management, so watch carefully.</p>

<p>For the example service I’m going to use memcached, from the memcached
package. It is started on package installation as demonstrated:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vagrant@precise-housepub:~$ sudo apt-get install memcached
...
Setting up memcached (1.4.13-0ubuntu2) ...
Starting memcached: memcached.
vagrant@precise-housepub:~$ service memcached status
 * memcached is running
vagrant@precise-housepub:~$ ps awux | grep memcached
 memcache 15176  0.0  0.3 323212  1180 ?        Sl   04:32   0:00 /usr/bin/memcached -m 64 -p 11211 -u memcache -l 127.0.0.1
</code></pre></div></div>

<p>As we can see, the memcached service is started. Of course, it is
using the default configuration, which means that it has a very small
memory size, and listens on localhost. While the recipe would be very
simple:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">package</span> <span class="s2">"memcached"</span>
</code></pre></div></div>

<p>This wouldn’t be very useful for discussion, or practical use
purposes. For now, I’m going to post the entire recipe I’m going to
discuss, and then break it down.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'memcached'</span><span class="p">][</span><span class="s1">'memory_max'</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">'memory'</span><span class="p">][</span><span class="s1">'total'</span><span class="p">].</span><span class="nf">to_i</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mf">0.65</span>

<span class="n">package</span> <span class="s2">"memcached"</span>

<span class="n">service</span> <span class="s2">"memcached"</span> <span class="k">do</span>
  <span class="n">supports</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s2">"/etc/memcached.conf"</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"memcached.conf.erb"</span>
  <span class="n">owner</span> <span class="s2">"root"</span>
  <span class="n">group</span> <span class="s2">"root"</span>
  <span class="n">mode</span> <span class="mo">00644</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[memcached]"</span>
  <span class="n">variables</span><span class="p">(</span>
    <span class="ss">:memory_max</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="p">[</span><span class="s1">'memcached'</span><span class="p">][</span><span class="s1">'memory_max'</span><span class="p">]</span>
    <span class="ss">:ip_addr</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="p">[</span><span class="s1">'ipaddress'</span><span class="p">]</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">"memcached"</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:start</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This recipe is fairly straightforward. First, it sets a node attribute
based on a calculation of the amount of memory installed in the
system. Then, it will install the memcached package. This of course
will start up the service with the unsuitable defaults already
discussed.</p>

<p>The first <code class="language-plaintext highlighter-rouge">service</code> resource occurance makes sure that the service is
enabled. This is the default behavior of the package manager, but this
also gives clear indication as to the intention of the recipe. Next,
the configuration file is managed. The exact content of the
<code class="language-plaintext highlighter-rouge">memcached.conf.erb</code> file isn’t particularly important. Let us presume
that the variables passed in are what we care about - that we want to
use 65% of the system’s total memory for memcached, and listen on the
default IP address. Maybe other tuning is happening, maybe not. Of
course, when the configuration is updated, we need to notify the
memcached service to restart.</p>

<p>Finally, the memcached service is started if it is not already
running. This occurs at the end to help remedy an issue where the
service might have been halted, or the configuration file was rendered
incorrectly (a typo?), so that we can correct such configuration
problems with Chef in a single subsequent run. This uses a feature of
Chef where resources can be declared multiple times with different
actions (or if desired, parameters).</p>

<p>The first time this recipe is run on a node, memcached will be
installed, started, configured, restarted. We’re not aiming to prevent
the auto-start from occurring at all, but we do automate the
additional steps required for handling that easily.</p>

  </div><a class="u-url" href="/blog/2012/07/26/autostarted-services" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/%20/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">jtimberman&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Copyright &copy; Joshua Timberman</li><li><a class="u-email" href="mailto:blog@housepub.org">blog@housepub.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jekyll" title="jekyll"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/jekyllrb" title="jekyllrb"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Operations, Automation, Deployment, Workflows, DevOps; see my About page for ways you can support me.</p>
      </div>
    </div>

    <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
      Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This
    work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons
      Attribution-ShareAlike 3.0 United States License</a>.
  </div>

</footer></body>

</html>
